##### 1. `Mysql `缓存池 --  `BufferPool `（官方文档： https://dev.mysql.com/doc/refman/8.0/en/innodb-buffer-pool.html）

1. 缓存池是主内存的一个区域，InnoDB在访问数据时缓存表数据和 索引数据，缓存池允许经常使用的数据直接从内存获取，可以加快处理速度。
2. 在一些专用的服务器上面， 缓存池的大小设置为 物理内存的 80%
3. 为了提高大量读取操作，缓存池被划分为包含多行的页面，缓存池使用链表连接多个页面，使用改进的最近最少算法（LRU）对消除高速缓存

##### 2.` Bufferpool`结构

<img src="C:\Users\localuser\AppData\Roaming\Typora\typora-user-images\image-20210803214703512.png" alt="image-20210803214703512" style="zoom:60%;" /> 

1. 缓存池 将常用的数据缓存在新的子列表中，非常用数据缓存在旧子列表

2. 缓存的 3/8 为 旧子列表， 5/8为新的子列表（新旧列表都有一个 head 和 tail）
3. 当InnoDB将一个页面读入缓存池时，是将该页面插入到中间点（midpoint）,也就是旧列表的头部（Sql查询的数据，以及InnoDB进行预读的数据）
4. 将旧列表的数据读取到新列表可以使数据具有更长的生命周期，如果是用户的操作导致数据的读取，就会马上把数据放到新列表的位置，如果是因为InnoDB预读，这不会将数据放到 新列表
5. 在数据库运行中，缓存池中没有访问的页面会被移动到尾部，最终移除，新旧列表中的页面也会根据其他页面的插入而移动

##### 3. 预读？

​	磁盘读写，并不是按需读取，而是按页读取，一次至少读一页数据（一般是4K），如果未来要读取的数据就在页中，就能够省去后续的磁盘IO，提高效率。

​	数据访问，通常都遵循“集中读写”的原则，使用一些数据，大概率会使用附近的数据，这就是所谓的“局部性原理”，它表明提前加载是有效的，确实能够减少磁盘IO。

**按页(4K)读取，和InnoDB的缓冲池设计有啥关系？**

（1）磁盘访问按页读取能够提高性能，所以缓冲池一般也是按页缓存数据；

（2）预读机制启示了我们，能把一些“可能要访问”的页提前加入缓冲池，避免未来的磁盘IO操作；



##### 4.  改进版的LRU算法解决的问题？（划分 新列表 与 旧列表解决的问题）

​	1. **预读失败**

​	针对数据库的 预读原理（局部性原理），会将数据提取读取到缓存池中，这会导致这些数据可能不会被访问，从而浪费缓存池空间，因此划分了 旧列表，预读的数据加载到旧列表头部，保证其拥有更短的生命周期。

 2. **MySQL缓冲池污染？**

    当某一个SQL语句，要批量扫描大量数据时，可能导致把缓冲池的所有页都替换出去，导致大量热数据被换出，MySQL性能急剧下降，这种情况叫缓冲池污染。

    例如 执行如下SQL;

    ~~~sql
    select * from user where name like %chenjj%;
    
    #  这个 SQL 只能获取少量数据，但是却要全表扫描，需要访问大量的页面，缓存步骤如下：
    （1） 将页面加载到缓存池中（旧列表头部）
    （2） 从页里面读出相关的 row (插入到新列表)
    （3） row里的name字段和字符串chenjj进行比较，如果符合条件，加入到结果集中
    （4） … 直到扫描完所有页中的所有row …
    ~~~

    这样导致的问题是，所有数据页都会被加载到新列表的头部，但是却只访问一次，大量的热点数据被置换出来

    

    **怎么这类扫码大量数据导致的缓冲池污染问题呢？**

    MySQL缓冲池加入了一个“老生代停留时间窗口”的机制：

    （1）假设T=老生代停留时间窗口；

    （2）插入老生代头部的页，即使立刻被访问，并不会立刻放入新生代头部；

    （3）只有**满足**“被访问”并且“在老生代停留时间”大于T，才会被放入新生代头部； （对应的 innodb_old_blocks_time 参数）

<img src="C:\Users\localuser\AppData\Roaming\Typora\typora-user-images\image-20210803222450223.png" alt="image-20210803222450223" style="zoom:67%;" />

Mysql中查询时间 T：

![image-20210804085355027](C:\Users\localuser\AppData\Roaming\Typora\typora-user-images\image-20210804085355027.png)

老生代停留时间窗口，单位是毫秒，默认是1000，即同时满足“被访问”与“在老生代停留时间超过1秒”两个条件，才会被插入到新生代头部。

注：参考博客（https://blog.csdn.net/suo082407128/article/details/102580630）、

https://www.cnblogs.com/maz9666/p/14447334.html

